from EsproChat import app
from pyrogram import filters
from pyrogram.enums import ChatAction
from pyrogram.types import Message
from config import OWNER_ID as MONGO_URL  
import g4f
from pymongo import MongoClient
import asyncio
import re

# âœ… MongoDB setup
mongo = MongoClient(MONGO_URI)
chatdb = mongo.ChatDB.chat_data

# âŒ Ignore if replying to or mentioning someone else
def is_message_for_someone_else(message: Message):
    if message.reply_to_message:
        replied_user = message.reply_to_message.from_user
        if replied_user and not replied_user.is_self:
            return True

    if message.entities:
        for entity in message.entities:
            if entity.type == "mention":
                mention_text = message.text[entity.offset : entity.offset + entity.length]
                if mention_text.lower() != f"@{BOT_USERNAME.lower()}":
                    return True
    return False

# âŒ Ignore if message contains a link
def contains_link(text):
    link_pattern = r"(https?://\S+|t\.me/\S+|www\.\S+|[\w\-]+\.(com|in|net|org|xyz|me|link|ly|site|bio|store))"
    return bool(re.search(link_pattern, text.lower()))

# âœ… Smart Chat Handler
@app.on_message(filters.text & ~filters.regex(r"^/"))
async def smart_bot_handler(client, message: Message):
    if is_message_for_someone_else(message) or contains_link(message.text):
        return

    await message.reply_chat_action(ChatAction.TYPING)
    await asyncio.sleep(1)

    try:
        user_input = message.text.strip().lower()

        # ğŸ” Check MongoDB
        data = chatdb.find_one({"question": user_input})
        if data:
            return await message.reply(data["answer"])

        # ğŸ§  GPT fallback with behavior detection
        base_prompt = f"""
Tum ek ladki ho jiska naam Espro hai. Tum real insaan ki tarah behave karti ho. Har response short, pyaar bhari aur natural Hindi mein do.

Agar koi pyar ya romantic baat kare to uske mood ke hisaab se jawab do. Agar normal sawal ho to simple aur sweet jawaab do.
Sirf 1-2 line mein jawab do.

User: {message.text}
Espro:
"""

        response = g4f.ChatCompletion.create(
            model=g4f.models.gpt_4,
            messages=[{"role": "user", "content": base_prompt}],
        )

        final_answer = response.strip()

        # âœ… Learn and save
        if final_answer:
            chatdb.update_one(
                {"question": user_input},
                {"$set": {"answer": final_answer}},
                upsert=True
            )
            await message.reply(final_answer)
        else:
            await message.reply("ğŸ˜“ Mujhe jawab nahi mila...")

    except Exception as e:
        await message.reply("ğŸ˜“ Error:\n" + str(e))

# âœ… /teach command
@app.on_message(filters.command("teach") & filters.text)
async def teach_command(client, message: Message):
    if message.from_user.id != OWNER_ID:
        return await message.reply("âŒ Sirf bot owner hi /teach use kar sakta hai.")

    try:
        text = message.text.split(" ", 1)[1]
        if "|" not in text:
            return await message.reply("âŒ Format:\n`/teach question | answer`")

        question, answer = text.split("|", 1)
        question = question.strip().lower()
        answer = answer.strip()

        chatdb.update_one(
            {"question": question},
            {"$set": {"answer": answer}},
            upsert=True
        )

        await message.reply("âœ… Bot ne naya jawab yaad kar liya!")

    except Exception as e:
        await message.reply("ğŸ˜“ Error:\n" + str(e))
